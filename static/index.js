(()=>{"use strict";function t(t){return t.replace(/[ !"#$%&'()*+,.\/:;<=>?@\[\\\]^`{|}~]/g,"\\$&")}function e(t){let e={};var o;e.hex=(o=t.text(),Array.from((new TextEncoder).encode(o)).map((t=>t.toString(16))).join("")),e.var="default";let n=t.attr("mathvariant");null!=n&&(e.var="normal"==n?"roman":n);let i=t.data("math-concept");return null!=i&&(e.concept=Number(i)),e}let o={limited_highlight:!1,show_definition:!1};$((function(){let t=$("#option-limited-highlight"),e=$("#option-show-definition");"true"==localStorage["option-limited-highlight"]?(t.prop("checked",!0),o.limited_highlight=!0):o.limited_highlight=!1,"true"==localStorage["option-show-definition"]?(e.prop("checked",!0),o.show_definition=!0):o.show_definition=!1,p(),t.on("click",(function(){$(this).prop("checked")?(localStorage["option-limited-highlight"]="true",o.limited_highlight=!0):(localStorage["option-limited-highlight"]="false",o.limited_highlight=!1),p()})),e.on("click",(function(){$(this).prop("checked")?(localStorage["option-show-definition"]="true",o.show_definition=!0):(localStorage["option-show-definition"]="false",o.show_definition=!1),p()}))})),$((function(){$(".sidebar-tab input.tab-title").each((function(){let t=this.id;"true"==localStorage[t]&&$(`#${t}`).prop("checked",!0),$(`#${t}`).on("change",(function(){$(this).prop("checked")?localStorage[t]=!0:localStorage[t]=!1}))}))}));let n={};$.ajax({url:"/mcdict.json",dataType:"json",async:!1,success:function(t){n=t}});let i=["#008b8b","#ff7f50","#ff4500","#2f4f4f","#006400","#dc143c","#c71585","#4169e1","#2e8b57","#ff1493","#191970","#ff69b4","#ff69b4","#0000cd","#f4a460","#ff00ff","#7cfc00","#d2691e","#a0522d","#800000","#9400d3","#556b2f","#4b0082","#808000"],l=0;for(let t in n)for(let e in n[t])for(let o in n[t][e])null!=n[t][e][o].description&&(n[t][e][o].color=i[l%i.length],l++);function c(t){return null!=t.concept?n[t.hex][t.var][t.concept]:void 0}function a(t){if(null!=n[t.hex])return n[t.hex][t.var]}function s(t){let o=c(e(t));null!=o&&null!=o.color&&t.attr("mathcolor",o.color)}$((function(){$("mi").each((function(){s($(this))}))}));let d={};function r(t,e,n){u(t);let i=c(e);var l;null==i||null==i.color?t.css("border-bottom","solid 2px #FF0000"):(t.css("background-color",`rgba(${(l=i.color,"#"==l.slice(0,1)&&(l=l.slice(1)),3==l.length&&(l=l.slice(0,1)+l.slice(0,1)+l.slice(1,2)+l.slice(1,2)+l.slice(2,3)+l.slice(2,3)),[l.slice(0,2),l.slice(2,4),l.slice(4,6)].map((function(t){return parseInt(t,16)}))).join()},0.3)`),o.show_definition&&1==n.type&&t.css("border-bottom","solid 3px")),t.attr({"data-sog-mi":n.mi_id,"data-sog-type":n.type,"data-sog-start":n.start_id,"data-sog-stop":n.stop_id})}function u(t){t.css("border-bottom",""),t.css("background-color","")}function p(){for(let n of d.sog){let i;if(n.start_id==n.stop_id)i=$("#"+t(n.start_id));else{let e=$("#"+t(n.start_id)),o=$("#"+t(n.stop_id));i=e.nextUntil("#"+t(n.stop_id)).addBack().add(o)}let l=e($("#"+t(n.mi_id)));if(o.limited_highlight&&null!=sessionStorage.mi_id){let o=e($("#"+t(sessionStorage.mi_id)));o.hex==l.hex&&o.var==l.var||u(i)}}for(let n of d.sog){let i;if(n.start_id==n.stop_id)i=$("#"+t(n.start_id));else{let e=$("#"+t(n.start_id)),o=$("#"+t(n.stop_id));i=e.nextUntil("#"+t(n.stop_id)).addBack().add(o)}let l=e($("#"+t(n.mi_id)));if(o.limited_highlight&&null!=sessionStorage.mi_id){let o=e($("#"+t(sessionStorage.mi_id)));o.hex==l.hex&&o.var==l.var&&r(i,l,n)}else r(i,l,n)}}$.ajax({url:"/sog.json",dataType:"json",async:!1,success:function(t){d=t}}),$((function(){$(document).tooltip({show:!1,hide:!1,items:"[data-math-concept]",content:function(){let t=c(e($(this)));if(null!=t){let e="NONE";return t.affixes.length>0&&(e=t.affixes.join(", ")),`${t.description} <span style="color: #808080;">[${e}] (arity: ${t.arity})</span>`}return"(No description)"},open:function(t,e){$("mi").each((function(){s($(this))}))}})})),$((function(){function i(o){o.attr("style","border: dotted 2px #000000; padding: 10px;");let i=e(o),c=a(i),d=o.attr("id");if(null!=c&&null!=d)if(c.length>0)!function(o,i,c){let a=`<input type="hidden" name="mi_id" value="${o}" />`,d="";for(let t in c){let e=c[t],n=`<input type="radio" name="concept" id="c${t}" value="${t}" ${Number(t)==i.concept?"checked":""} />`,l="NONE";e.affixes.length>0&&(l=e.affixes.join(", ")),d+=`${n}<span class="keep"><label for="c${t}">\n${e.description} <span style="color: #808080;">[${l}] (arity: ${e.arity})</span>\n(<a class="edit-concept" data-mi="${o}" data-concept="${t}" href="javascript:void(0);">edit</a>)\n</label></span>`}let r=`<p>ID: <span style="font-family: monospace;">${o}</span><hr color="#FFF"><form id="form-${o}" method="POST">${a+`<div class="keep">${d}</div><p><button id="assign-concept">Assign</button> <button id="remove-concept" type="button">Remove</button> <button id="new-concept" type="button">New</button></p>`}</form></p>`,u=$("#anno-box");u.html(r),$("button#assign-concept").button(),$("button#assign-concept").on("click",(function(){let e=u.find(`#form-${t(o)}`);if(!($(`#form-${t(o)} input:checked`).length>0))return alert("Please select a concept."),!1;localStorage.scroll_top=$(window).scrollTop(),e.attr("action","/_concept"),e.trigger("submit")})),$("button#remove-concept").button(),$("button#remove-concept").on("click",(function(){let e=u.find(`#form-${t(o)}`);e.attr("action","/_remove_concept"),e.trigger("submit")})),l(i),$("a.edit-concept").on("click",(function(){let o=$(this).attr("data-mi"),i=$(this).attr("data-concept");null!=o&&null!=i&&function(t,e){let o=$("#concept-dialog-template").clone();o.removeAttr("id");let i=o.find("#concept-form");i.attr("action","/_update_concept");let l=n[t.hex][t.var][e];i.find("textarea").text(l.description),i.find('input[name="arity"]').attr("value",l.arity),l.affixes.forEach((function(t,e){i.find(`select[name="affixes${e}"]`).find(`option[value="${t}"]`).prop("selected",!0)})),o.dialog({modal:!0,title:"Edit Concept",width:500,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),i.append(`<input type="hidden" name="idf_hex" value="${t.hex}" />`),i.append(`<input type="hidden" name="idf_var" value="${t.var}" />`),i.append(`<input type="hidden" name="concept_id" value="${e}" />`),i.trigger("submit")},Cancel:function(){$(this).dialog("close")}}})}(e($("#"+t(o))),Number(i))})),$("mi").each((function(){s($(this))}))}(d,i,c);else{let t=`<p>ID: <span style="font-family: monospace;">${d}</span><hr color="#FFF"><p>No concept is available.</p><p><button id="new-concept" type="button">New</button></p></p>`;$("#anno-box").html(t),l(i)}}function l(t){$("button#new-concept").button(),$("button#new-concept").on("click",(function(){let e=$("#concept-dialog-template").clone();e.attr("id","concept-dialog"),e.removeClass("concept-dialog");let o=e.find("#concept-form");o.attr("action","/_new_concept"),e.dialog({modal:!0,title:"New Concept",width:500,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),o.append(`<input type="hidden" name="idf_hex" value="${t.hex}" />`),o.append(`<input type="hidden" name="idf_var" value="${t.var}" />`),o.trigger("submit")},Cancel:function(){$(this).dialog("close")}},close:function(){$(this).remove()}})}))}$("mi").on("click",(function(){let e=sessionStorage.getItem("mi_id");null!=e&&$("#"+t(e)).removeAttr("style"),sessionStorage.mi_id=$(this).attr("id"),i($(this)),"true"==localStorage["option-limited-highlight"]&&(o.limited_highlight=!0),p()})),$(window).scrollTop(localStorage.scroll_top);let c=sessionStorage.mi_id;null!=c&&i($("#"+t(c)))})),$((function(){let o,n;$(document).on("mouseup",(function(i){o=i.pageX,n=i.pageY,$(".sog-menu").css("display","none");let[l,a,s]=function(){var t,e,o,n;let i;if(window.getSelection?i=window.getSelection():document.getSelection&&(i=document.getSelection()),null==i||"Range"!=i.type)return[void 0,void 0,void 0];let l=null===(t=null==i?void 0:i.anchorNode)||void 0===t?void 0:t.parentElement,c=null===(e=null==i?void 0:i.focusNode)||void 0===e?void 0:e.parentElement;if(null==l||null==c)return[void 0,void 0,void 0];if(0==$(l).parents(".main").length||0==$(c).parents(".main").length)return[void 0,void 0,void 0];let a,s,d,r,u=l.getBoundingClientRect(),p=c.getBoundingClientRect();return u.top<p.top||u.top==p.top&&u.left<=p.left?[a,s]=[l,c]:[a,s]=[c,l],"gd_word"==a.className?d=a.id:"gd_word"==(null===(o=a.nextElementSibling)||void 0===o?void 0:o.className)?d=a.nextElementSibling.id:console.warn("Invalid span for a source of grounding"),"gd_word"==s.className?r=s.id:"gd_word"==(null===(n=s.previousElementSibling)||void 0===n?void 0:n.className)?r=s.previousElementSibling.id:console.warn("Invalid span for a source of grounding"),[d,r,a]}();if(null==s)return;$(".sog-menu input[type=submit]").button();let d=sessionStorage.mi_id;null!=d&&null!=c(e($("#"+t(d))))&&$(".sog-menu").css({left:o,top:n-20}).fadeIn(200).css("display","flex");let r=`<p>Selected mi: <span style="font-family: monospace;">${d}</span></p>`;$(".sog-add-menu-info").html(r),$(".sog-menu .sog-add").off("click"),$(".sog-menu .sog-add").on("click",(function(){$(".sog-menu").css("display","none");let t={mi_id:d,start_id:l,stop_id:a};localStorage.scroll_top=$(window).scrollTop(),$.when($.post("/_add_sog",t)).done((function(){location.reload()})).fail((function(){console.error("Failed to POST _add_sog!")}))})),null!=(null==s?void 0:s.getAttribute("data-sog-mi"))?$(".sog-mod-menu").css("display","inherit"):$(".sog-mod-menu").css("display","none");let u=s.getAttribute("data-sog-mi"),p=Number(s.getAttribute("data-sog-type")),f=s.getAttribute("data-sog-start"),g=s.getAttribute("data-sog-stop"),m="unknown";0==p?m="declaration":1==p?m="definition":2==p&&(m="others");let h=`<p>SoG for <span style="font-family: monospace;">${u}</span><br/>Type: ${m}</p>`;$(".sog-mod-menu-info").html(h),$(".sog-menu .sog-type").off("click"),$(".sog-menu .sog-type").on("click",(function(){if($(".sog-menu").css("display","none"),null==s)return;let t=$("#sog-type-dialog-template").clone();t.attr("id","sog-type-dialog"),t.removeClass("sog-type-dialog");let e=t.find("#sog-type-form");e.attr("action","/_change_sog_type"),t.find(`input[value="${p}"]`).prop("checked",!0),t.dialog({modal:!0,title:"Change SoG Type",width:200,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),e.append(`<input type="hidden" name="mi_id" value="${u}" />`),e.append(`<input type="hidden" name="start_id" value="${f}" />`),e.append(`<input type="hidden" name="stop_id" value="${g}" />`),e.trigger("submit")},Cancel:function(){$(this).dialog("close")}},close:function(){$(this).remove()}})})),$(".sog-menu .sog-del").off("click"),$(".sog-menu .sog-del").on("click",(function(){if($(".sog-menu").css("display","none"),null==s)return;let t={mi_id:s.getAttribute("data-sog-mi"),start_id:s.getAttribute("data-sog-start"),stop_id:s.getAttribute("data-sog-stop")};localStorage.scroll_top=$(window).scrollTop(),$.when($.post("/_delete_sog",t)).done((function(){location.reload()})).fail((function(){console.error("Failed to POST _delete_sog!")}))}))}))})),$((function(){$("mi").each((function(){!function(t){let o=a(e(t));null==t.data("math-concept")&&null!=o&&t.attr("mathbackground","#D3D3D3")}($(this))}))}));for(let t=1;t<10;t++)$(document).on("keydown",(function(e){var o;$("#concept-dialog")[0]||e.key==t.toString(10)&&(o=t,$("#c"+(o-1))[0]&&($('input[name="concept"]').prop("checked",!1),$("#c"+(o-1)).prop("checked",!0)))}));function f(t){if(console.log("cur_node: ",t),t.children().length>0){let o=t.children(":first-child");return o.is("mi")&&null==c(e(o))?o:f(o)}{for(;0==t.next().length;){if(0==t.parent().length)return $();t=t.parent()}let o=t.next();return o.is("mi")&&null==c(e(o))?o:f(o)}}function g(t){if(t.children().length>0){let o=t.children(":last-child");return o.is("mi")&&null==c(e(o))?o:g(o)}{for(;0==t.prev().length;){if(0==t.parent().length)return $();t=t.parent()}let o=t.prev();return o.is("mi")&&null==c(e(o))?o:g(o)}}$(document).on("keydown",(function(t){"Enter"==t.key&&($("#concept-dialog")[0]||$("#assign-concept").trigger("click"))})),$((function(){0!=$("#error-message").text().length&&$("#error-dialog").dialog({dialogClass:"error-dialog",modal:!0,title:"Error",buttons:{OK:function(){$(this).dialog("close")}}})})),$((function(){$("button#jump-to-next-unannotated-mi").on("click",(function(){var e;let o=$("#"+t(sessionStorage.mi_id));if(0!=o.length){let t=f(o),n=null===(e=null==t?void 0:t.offset())||void 0===e?void 0:e.top,i=$(window).height();null!=n&&null!=i&&($(window).scrollTop(n-i/2),t.trigger("click"))}})),$("button#jump-to-prev-unannotated-mi").on("click",(function(){var e;let o=$("#"+t(sessionStorage.mi_id));if(0!=o.length){let t=g(o),n=null===(e=null==t?void 0:t.offset())||void 0===e?void 0:e.top,i=$(window).height();null!=n&&null!=i&&($(window).scrollTop(n-i/2),t.trigger("click"))}}))})),$((function(){$(window).scrollTop(localStorage.scroll_top)}))})();