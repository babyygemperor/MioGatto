(()=>{"use strict";function t(t){return t.replace(/[ !"#$%&'()*+,.\/:;<=>?@\[\\\]^`{|}~]/g,"\\$&")}function e(t){let e={};var o;e.hex=(o=t.text(),Array.from((new TextEncoder).encode(o)).map((t=>t.toString(16))).join("")),e.var="default";let n=t.attr("mathvariant");null!=n&&(e.var="normal"==n?"roman":n);let i=t.data("math-concept");return null!=i&&(e.concept=Number(i)),e}function o(t){return null!=t.concept?c[t.hex][t.var][t.concept]:void 0}function n(t){if(null!=c[t.hex])return c[t.hex][t.var]}function i(t){let o=[];t.is("mi")&&null!=n(e(t))&&(o=[t]);for(let e=0;e<t.children().length;e++){let n=t.children().eq(e);o=o.concat(i(n))}return o}let l=0,c={};$.ajax({url:"/mcdict.json",dataType:"json",async:!1,success:function(t){l=t[0],c=t[1]}});let a=["#008b8b","#ff7f50","#ff4500","#2f4f4f","#006400","#dc143c","#c71585","#4169e1","#2e8b57","#ff1493","#191970","#ff69b4","#ff69b4","#0000cd","#f4a460","#ff00ff","#7cfc00","#d2691e","#a0522d","#800000","#9400d3","#556b2f","#4b0082","#808000"],d=0;for(let t in c)for(let e in c[t])for(let o in c[t][e])null!=c[t][e][o].description&&(c[t][e][o].color=a[d%a.length],d++);let s={};$.ajax({url:"/sog.json",dataType:"json",async:!1,success:function(t){s=t}}),$((function(){0!=$("#error-message").text().length&&$("#error-dialog").dialog({dialogClass:"error-dialog",modal:!0,title:"Error",buttons:{OK:function(){$(this).dialog("close")}}})}));let r={limited_highlight:!1,show_definition:!1};function u(t){let n=o(e(t));null!=n&&null!=n.color&&t.attr("mathcolor",n.color)}function p(t,e,n){g(t);let i=o(e);var l;null==i||null==i.color?t.css("border-bottom","solid 2px #FF0000"):(t.css("background-color",`rgba(${(l=i.color,"#"==l.slice(0,1)&&(l=l.slice(1)),3==l.length&&(l=l.slice(0,1)+l.slice(0,1)+l.slice(1,2)+l.slice(1,2)+l.slice(2,3)+l.slice(2,3)),[l.slice(0,2),l.slice(2,4),l.slice(4,6)].map((function(t){return parseInt(t,16)}))).join()},0.3)`),r.show_definition&&1==n.type&&t.css("border-bottom","solid 3px")),t.attr({"data-sog-mi":n.mi_id,"data-sog-type":n.type,"data-sog-start":n.start_id,"data-sog-stop":n.stop_id})}function g(t){t.css("border-bottom",""),t.css("background-color","")}function f(){for(let o of s.sog){let n;if(o.start_id==o.stop_id)n=$("#"+t(o.start_id));else{let e=$("#"+t(o.start_id)),i=$("#"+t(o.stop_id));n=e.nextUntil("#"+t(o.stop_id)).addBack().add(i)}let i=e($("#"+t(o.mi_id)));if(r.limited_highlight&&null!=sessionStorage.mi_id){let o=e($("#"+t(sessionStorage.mi_id)));o.hex==i.hex&&o.var==i.var||g(n)}}for(let o of s.sog){let n;if(o.start_id==o.stop_id)n=$("#"+t(o.start_id));else{let e=$("#"+t(o.start_id)),i=$("#"+t(o.stop_id));n=e.nextUntil("#"+t(o.stop_id)).addBack().add(i)}let i=e($("#"+t(o.mi_id)));if(r.limited_highlight&&null!=sessionStorage.mi_id){let l=e($("#"+t(sessionStorage.mi_id)));l.hex==i.hex&&l.var==i.var&&p(n,i,o)}else p(n,i,o)}}$((function(){let t=$("#option-limited-highlight"),e=$("#option-show-definition");"true"==localStorage["option-limited-highlight"]?(t.prop("checked",!0),r.limited_highlight=!0):r.limited_highlight=!1,"true"==localStorage["option-show-definition"]?(e.prop("checked",!0),r.show_definition=!0):r.show_definition=!1,f(),t.on("click",(function(){$(this).prop("checked")?(localStorage["option-limited-highlight"]="true",r.limited_highlight=!0):(localStorage["option-limited-highlight"]="false",r.limited_highlight=!1),f()})),e.on("click",(function(){$(this).prop("checked")?(localStorage["option-show-definition"]="true",r.show_definition=!0):(localStorage["option-show-definition"]="false",r.show_definition=!1),f()}))})),$((function(){$(".sidebar-tab input.tab-title").each((function(){let t=this.id;"true"==localStorage[t]&&$(`#${t}`).prop("checked",!0),$(`#${t}`).on("change",(function(){$(this).prop("checked")?localStorage[t]=!0:localStorage[t]=!1}))}))})),$((function(){$("mi").each((function(){u($(this))}))})),$((function(){$(document).tooltip({show:!1,hide:!1,items:"[data-math-concept]",content:function(){let t=o(e($(this)));if(null!=t){let e="NONE";return t.affixes.length>0&&(e=t.affixes.join(", ")),`${t.description} <span style="color: #808080;">[${e}] (arity: ${t.arity})</span>`}return"(No description)"},open:function(t,e){$("mi").each((function(){u($(this))}))}})})),$((function(){function o(o){o.attr("style","border: dotted 2px #000000; padding: 10px;");let a=e(o),d=n(a),s=o.attr("id");if(null!=d&&null!=s)if(d.length>0)!function(o,n,a){let d=`<input type="hidden" name="mi_id" value="${o}" />`,s="";for(let t in a){let e=a[t],i=`<input type="radio" name="concept" id="c${t}" value="${t}" ${Number(t)==n.concept?"checked":""} />`,l="NONE";e.affixes.length>0&&(l=e.affixes.join(", ")),s+=`${i}<span class="keep"><label for="c${t}">\n${e.description} <span style="color: #808080;">[${l}] (arity: ${e.arity})</span>\n(<a class="edit-concept" data-mi="${o}" data-concept="${t}" href="javascript:void(0);">edit</a>)\n</label></span>`}let r=`<p>ID: <span style="font-family: monospace;">${o}</span><hr color="#FFF"><form id="form-${o}" method="POST">${d+`<div class="keep">${s}</div><p><button id="assign-concept">Assign</button> <button id="remove-concept" type="button">Remove</button> <button id="new-concept" type="button">New</button></p>`}</form></p>`,p=$("#anno-box");p.html(r),$("button#assign-concept").button(),$("button#assign-concept").on("click",(function(){let e=p.find(`#form-${t(o)}`);if(!($(`#form-${t(o)} input:checked`).length>0))return alert("Please select a concept."),!1;localStorage.scroll_top=$(window).scrollTop(),e.attr("action","/_concept"),e.append(`<input type="hidden" name="mcdict_edit_id" value="${l}" />`),e.trigger("submit")})),$("button#remove-concept").button(),$("button#remove-concept").on("click",(function(){let e=p.find(`#form-${t(o)}`);e.attr("action","/_remove_concept"),e.append(`<input type="hidden" name="mcdict_edit_id" value="${l}" />`),e.trigger("submit")})),i(n),$("a.edit-concept").on("click",(function(){let o=$(this).attr("data-mi"),n=$(this).attr("data-concept");null!=o&&null!=n&&function(t,e){let o=$("#concept-dialog-template").clone();o.removeAttr("id");let n=o.find("#concept-form");n.attr("action","/_update_concept");let i=c[t.hex][t.var][e];n.find("textarea").text(i.description),n.find('input[name="arity"]').attr("value",i.arity),i.affixes.forEach((function(t,e){n.find(`select[name="affixes${e}"]`).find(`option[value="${t}"]`).prop("selected",!0)})),o.dialog({modal:!0,title:"Edit Concept",width:500,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),n.append(`<input type="hidden" name="mcdict_edit_id" value="${l}" />`),n.append(`<input type="hidden" name="idf_hex" value="${t.hex}" />`),n.append(`<input type="hidden" name="idf_var" value="${t.var}" />`),n.append(`<input type="hidden" name="concept_id" value="${e}" />`),n.trigger("submit")},Cancel:function(){$(this).dialog("close")}}})}(e($("#"+t(o))),Number(n))})),$("mi").each((function(){u($(this))}))}(s,a,d);else{let t=`<p>ID: <span style="font-family: monospace;">${s}</span><hr color="#FFF"><p>No concept is available.</p><p><button id="new-concept" type="button">New</button></p></p>`;$("#anno-box").html(t),i(a)}}function i(t){$("button#new-concept").button(),$("button#new-concept").on("click",(function(){let e=$("#concept-dialog-template").clone();e.attr("id","concept-dialog"),e.removeClass("concept-dialog");let o=e.find("#concept-form");o.attr("action","/_new_concept"),e.dialog({modal:!0,title:"New Concept",width:500,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),o.append(`<input type="hidden" name="mcdict_edit_id" value="${l}" />`),o.append(`<input type="hidden" name="idf_hex" value="${t.hex}" />`),o.append(`<input type="hidden" name="idf_var" value="${t.var}" />`),o.trigger("submit")},Cancel:function(){$(this).dialog("close")}},close:function(){$(this).remove()}})}))}$("mi").on("click",(function(){let e=sessionStorage.getItem("mi_id");null!=e&&$("#"+t(e)).removeAttr("style"),sessionStorage.mi_id=$(this).attr("id"),o($(this)),"true"==localStorage["option-limited-highlight"]&&(r.limited_highlight=!0),f()})),$(window).scrollTop(localStorage.scroll_top);let a=sessionStorage.mi_id;null!=a&&o($("#"+t(a)))})),$((function(){let n,i;$(document).on("mouseup",(function(c){n=c.pageX,i=c.pageY,$(".sog-menu").css("display","none");let[a,d,s]=function(){var t,e,o,n;let i;if(window.getSelection?i=window.getSelection():document.getSelection&&(i=document.getSelection()),null==i||"Range"!=i.type)return[void 0,void 0,void 0];let l=null===(t=null==i?void 0:i.anchorNode)||void 0===t?void 0:t.parentElement,c=null===(e=null==i?void 0:i.focusNode)||void 0===e?void 0:e.parentElement;if(null==l||null==c)return[void 0,void 0,void 0];if(0==$(l).parents(".main").length||0==$(c).parents(".main").length)return[void 0,void 0,void 0];let a,d,s,r,u=l.getBoundingClientRect(),p=c.getBoundingClientRect();return u.top<p.top||u.top==p.top&&u.left<=p.left?[a,d]=[l,c]:[a,d]=[c,l],"gd_word"==a.className?s=a.id:"gd_word"==(null===(o=a.nextElementSibling)||void 0===o?void 0:o.className)?s=a.nextElementSibling.id:console.warn("Invalid span for a source of grounding"),"gd_word"==d.className?r=d.id:"gd_word"==(null===(n=d.previousElementSibling)||void 0===n?void 0:n.className)?r=d.previousElementSibling.id:console.warn("Invalid span for a source of grounding"),[s,r,a]}();if(null==s)return;$(".sog-menu input[type=submit]").button();let r=sessionStorage.mi_id;null!=r&&null!=o(e($("#"+t(r))))&&$(".sog-menu").css({left:n,top:i-20}).fadeIn(200).css("display","flex");let u=`<p>Selected mi: <span style="font-family: monospace;">${r}</span></p>`;$(".sog-add-menu-info").html(u),$(".sog-menu .sog-add").off("click"),$(".sog-menu .sog-add").on("click",(function(){$(".sog-menu").css("display","none");let t={mcdict_edit_id:l,mi_id:r,start_id:a,stop_id:d};localStorage.scroll_top=$(window).scrollTop(),$.when($.post("/_add_sog",t)).done((function(){location.reload()})).fail((function(){console.error("Failed to POST _add_sog!")}))})),null!=(null==s?void 0:s.getAttribute("data-sog-mi"))?$(".sog-mod-menu").css("display","inherit"):$(".sog-mod-menu").css("display","none");let p=s.getAttribute("data-sog-mi"),g=Number(s.getAttribute("data-sog-type")),f=s.getAttribute("data-sog-start"),m=s.getAttribute("data-sog-stop"),h="unknown";0==g?h="declaration":1==g?h="definition":2==g&&(h="others");let _=`<p>SoG for <span style="font-family: monospace;">${p}</span><br/>Type: ${h}</p>`;$(".sog-mod-menu-info").html(_),$(".sog-menu .sog-type").off("click"),$(".sog-menu .sog-type").on("click",(function(){if($(".sog-menu").css("display","none"),null==s)return;let t=$("#sog-type-dialog-template").clone();t.attr("id","sog-type-dialog"),t.removeClass("sog-type-dialog");let e=t.find("#sog-type-form");e.attr("action","/_change_sog_type"),t.find(`input[value="${g}"]`).prop("checked",!0),t.dialog({modal:!0,title:"Change SoG Type",width:200,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),e.append(`<input type="hidden" name="mcdict_edit_id" value="${l}" />`),e.append(`<input type="hidden" name="mi_id" value="${p}" />`),e.append(`<input type="hidden" name="start_id" value="${f}" />`),e.append(`<input type="hidden" name="stop_id" value="${m}" />`),e.trigger("submit")},Cancel:function(){$(this).dialog("close")}},close:function(){$(this).remove()}})})),$(".sog-menu .sog-del").off("click"),$(".sog-menu .sog-del").on("click",(function(){if($(".sog-menu").css("display","none"),null==s)return;let t={mcdict_edit_id:l,mi_id:s.getAttribute("data-sog-mi"),start_id:s.getAttribute("data-sog-start"),stop_id:s.getAttribute("data-sog-stop")};localStorage.scroll_top=$(window).scrollTop(),$.when($.post("/_delete_sog",t)).done((function(){location.reload()})).fail((function(){console.error("Failed to POST _delete_sog!")}))}))}))})),$((function(){$("mi").each((function(){!function(t){let o=n(e(t));null==t.data("math-concept")&&null!=o&&t.attr("mathbackground","#D3D3D3")}($(this))}))}));for(let t=1;t<10;t++)$(document).on("keydown",(function(e){var o;$("#concept-dialog")[0]||e.key==t.toString(10)&&(o=t,$("#c"+(o-1))[0]&&($('input[name="concept"]').prop("checked",!1),$("#c"+(o-1)).prop("checked",!0)))}));$(document).on("keydown",(function(t){"Enter"==t.key&&($("#concept-dialog")[0]||$("#assign-concept").trigger("click"))})),$(document).on("keydown",(function(t){"j"==t.key?$("button#jump-to-next-unannotated-mi").trigger("click"):"k"==t.key&&$("button#jump-to-prev-unannotated-mi").trigger("click")}));let m=[],h={};$((function(){m=i($(":root"));for(let t=0;t<m.length;t++){let e=m[t].attr("id");null!=e?h[e]=t:(console.error("mi_id undefiend!"),console.error(t),console.error(m[t]))}})),$((function(){$("button#jump-to-next-unannotated-mi").button(),$("button#jump-to-next-unannotated-mi").on("click",(function(){var t;let n=m.length-1;null!=sessionStorage.mi_id&&sessionStorage.mi_id in h&&(n=h[sessionStorage.mi_id]);let i=function(t){for(let n=0;n<m.length;n++){let i=(t+n)%m.length;if(null==o(e(m[i])))return i}}((n+1)%m.length);if(null!=i){let e=m[i],o=null===(t=null==e?void 0:e.offset())||void 0===t?void 0:t.top,n=$(window).height();null!=o&&null!=n&&($(window).scrollTop(o-n/2),e.trigger("click"))}})),$("button#jump-to-prev-unannotated-mi").button(),$("button#jump-to-prev-unannotated-mi").on("click",(function(){var t;let n=0;null!=sessionStorage.mi_id&&sessionStorage.mi_id in h&&(n=h[sessionStorage.mi_id]);let i=function(t){for(let n=m.length;n>0;n--){let i=(t+n)%m.length;if(null==o(e(m[i])))return i}}((n+m.length-1)%m.length);if(null!=i){let e=m[i],o=null===(t=null==e?void 0:e.offset())||void 0===t?void 0:t.top,n=$(window).height();null!=o&&null!=n&&($(window).scrollTop(o-n/2),e.trigger("click"))}}))})),$((function(){$(window).scrollTop(localStorage.scroll_top)}))})();