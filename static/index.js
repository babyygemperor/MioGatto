(()=>{"use strict";function t(t){return t.replace(/[ !"#$%&'()*+,.\/:;<=>?@\[\\\]^`{|}~]/g,"\\$&")}function e(t){let e={};var o;e.hex=(o=t.text(),Array.from((new TextEncoder).encode(o)).map((t=>t.toString(16))).join("")),e.var="default";let n=t.attr("mathvariant");null!=n&&(e.var="normal"==n?"roman":n);let i=t.data("math-concept");return null!=i&&(e.concept=Number(i)),e}let o={limited_highlight:!1,show_definition:!1};$((function(){let t=$("#option-limited-highlight"),e=$("#option-show-definition");"true"==localStorage["option-limited-highlight"]?(t.prop("checked",!0),o.limited_highlight=!0):o.limited_highlight=!1,"true"==localStorage["option-show-definition"]?(e.prop("checked",!0),o.show_definition=!0):o.show_definition=!1,g(),t.on("click",(function(){$(this).prop("checked")?(localStorage["option-limited-highlight"]="true",o.limited_highlight=!0):(localStorage["option-limited-highlight"]="false",o.limited_highlight=!1),g()})),e.on("click",(function(){$(this).prop("checked")?(localStorage["option-show-definition"]="true",o.show_definition=!0):(localStorage["option-show-definition"]="false",o.show_definition=!1),g()}))})),$((function(){$(".sidebar-tab input.tab-title").each((function(){let t=this.id;"true"==localStorage[t]&&$(`#${t}`).prop("checked",!0),$(`#${t}`).on("change",(function(){$(this).prop("checked")?localStorage[t]=!0:localStorage[t]=!1}))}))}));let n=0,i={};$.ajax({url:"/mcdict.json",dataType:"json",async:!1,success:function(t){n=t[0],i=t[1]}});let l=["#008b8b","#ff7f50","#ff4500","#2f4f4f","#006400","#dc143c","#c71585","#4169e1","#2e8b57","#ff1493","#191970","#ff69b4","#ff69b4","#0000cd","#f4a460","#ff00ff","#7cfc00","#d2691e","#a0522d","#800000","#9400d3","#556b2f","#4b0082","#808000"],c=0;for(let t in i)for(let e in i[t])for(let o in i[t][e])null!=i[t][e][o].description&&(i[t][e][o].color=l[c%l.length],c++);function a(t){return null!=t.concept?i[t.hex][t.var][t.concept]:void 0}function d(t){if(null!=i[t.hex])return i[t.hex][t.var]}function s(t){let o=a(e(t));null!=o&&null!=o.color&&t.attr("mathcolor",o.color)}$((function(){$("mi").each((function(){s($(this))}))}));let r={};function u(t,e,n){p(t);let i=a(e);var l;null==i||null==i.color?t.css("border-bottom","solid 2px #FF0000"):(t.css("background-color",`rgba(${(l=i.color,"#"==l.slice(0,1)&&(l=l.slice(1)),3==l.length&&(l=l.slice(0,1)+l.slice(0,1)+l.slice(1,2)+l.slice(1,2)+l.slice(2,3)+l.slice(2,3)),[l.slice(0,2),l.slice(2,4),l.slice(4,6)].map((function(t){return parseInt(t,16)}))).join()},0.3)`),o.show_definition&&1==n.type&&t.css("border-bottom","solid 3px")),t.attr({"data-sog-mi":n.mi_id,"data-sog-type":n.type,"data-sog-start":n.start_id,"data-sog-stop":n.stop_id})}function p(t){t.css("border-bottom",""),t.css("background-color","")}function g(){for(let n of r.sog){let i;if(n.start_id==n.stop_id)i=$("#"+t(n.start_id));else{let e=$("#"+t(n.start_id)),o=$("#"+t(n.stop_id));i=e.nextUntil("#"+t(n.stop_id)).addBack().add(o)}let l=e($("#"+t(n.mi_id)));if(o.limited_highlight&&null!=sessionStorage.mi_id){let o=e($("#"+t(sessionStorage.mi_id)));o.hex==l.hex&&o.var==l.var||p(i)}}for(let n of r.sog){let i;if(n.start_id==n.stop_id)i=$("#"+t(n.start_id));else{let e=$("#"+t(n.start_id)),o=$("#"+t(n.stop_id));i=e.nextUntil("#"+t(n.stop_id)).addBack().add(o)}let l=e($("#"+t(n.mi_id)));if(o.limited_highlight&&null!=sessionStorage.mi_id){let o=e($("#"+t(sessionStorage.mi_id)));o.hex==l.hex&&o.var==l.var&&u(i,l,n)}else u(i,l,n)}}$.ajax({url:"/sog.json",dataType:"json",async:!1,success:function(t){r=t}}),$((function(){$(document).tooltip({show:!1,hide:!1,items:"[data-math-concept]",content:function(){let t=a(e($(this)));if(null!=t){let e="NONE";return t.affixes.length>0&&(e=t.affixes.join(", ")),`${t.description} <span style="color: #808080;">[${e}] (arity: ${t.arity})</span>`}return"(No description)"},open:function(t,e){$("mi").each((function(){s($(this))}))}})})),$((function(){function l(o){o.attr("style","border: dotted 2px #000000; padding: 10px;");let l=e(o),a=d(l),r=o.attr("id");if(null!=a&&null!=r)if(a.length>0)!function(o,l,a){let d=`<input type="hidden" name="mi_id" value="${o}" />`,r="";for(let t in a){let e=a[t],n=`<input type="radio" name="concept" id="c${t}" value="${t}" ${Number(t)==l.concept?"checked":""} />`,i="NONE";e.affixes.length>0&&(i=e.affixes.join(", ")),r+=`${n}<span class="keep"><label for="c${t}">\n${e.description} <span style="color: #808080;">[${i}] (arity: ${e.arity})</span>\n(<a class="edit-concept" data-mi="${o}" data-concept="${t}" href="javascript:void(0);">edit</a>)\n</label></span>`}let u=`<p>ID: <span style="font-family: monospace;">${o}</span><hr color="#FFF"><form id="form-${o}" method="POST">${d+`<div class="keep">${r}</div><p><button id="assign-concept">Assign</button> <button id="remove-concept" type="button">Remove</button> <button id="new-concept" type="button">New</button></p>`}</form></p>`,p=$("#anno-box");p.html(u),$("button#assign-concept").button(),$("button#assign-concept").on("click",(function(){let e=p.find(`#form-${t(o)}`);if(!($(`#form-${t(o)} input:checked`).length>0))return alert("Please select a concept."),!1;localStorage.scroll_top=$(window).scrollTop(),e.attr("action","/_concept"),e.append(`<input type="hidden" name="mcdict_edit_id" value="${n}" />`),e.trigger("submit")})),$("button#remove-concept").button(),$("button#remove-concept").on("click",(function(){let e=p.find(`#form-${t(o)}`);e.attr("action","/_remove_concept"),e.append(`<input type="hidden" name="mcdict_edit_id" value="${n}" />`),e.trigger("submit")})),c(l),$("a.edit-concept").on("click",(function(){let o=$(this).attr("data-mi"),l=$(this).attr("data-concept");null!=o&&null!=l&&function(t,e){let o=$("#concept-dialog-template").clone();o.removeAttr("id");let l=o.find("#concept-form");l.attr("action","/_update_concept");let c=i[t.hex][t.var][e];l.find("textarea").text(c.description),l.find('input[name="arity"]').attr("value",c.arity),c.affixes.forEach((function(t,e){l.find(`select[name="affixes${e}"]`).find(`option[value="${t}"]`).prop("selected",!0)})),o.dialog({modal:!0,title:"Edit Concept",width:500,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),l.append(`<input type="hidden" name="mcdict_edit_id" value="${n}" />`),l.append(`<input type="hidden" name="idf_hex" value="${t.hex}" />`),l.append(`<input type="hidden" name="idf_var" value="${t.var}" />`),l.append(`<input type="hidden" name="concept_id" value="${e}" />`),l.trigger("submit")},Cancel:function(){$(this).dialog("close")}}})}(e($("#"+t(o))),Number(l))})),$("mi").each((function(){s($(this))}))}(r,l,a);else{let t=`<p>ID: <span style="font-family: monospace;">${r}</span><hr color="#FFF"><p>No concept is available.</p><p><button id="new-concept" type="button">New</button></p></p>`;$("#anno-box").html(t),c(l)}}function c(t){$("button#new-concept").button(),$("button#new-concept").on("click",(function(){let e=$("#concept-dialog-template").clone();e.attr("id","concept-dialog"),e.removeClass("concept-dialog");let o=e.find("#concept-form");o.attr("action","/_new_concept"),e.dialog({modal:!0,title:"New Concept",width:500,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),o.append(`<input type="hidden" name="mcdict_edit_id" value="${n}" />`),o.append(`<input type="hidden" name="idf_hex" value="${t.hex}" />`),o.append(`<input type="hidden" name="idf_var" value="${t.var}" />`),o.trigger("submit")},Cancel:function(){$(this).dialog("close")}},close:function(){$(this).remove()}})}))}$("mi").on("click",(function(){let e=sessionStorage.getItem("mi_id");null!=e&&$("#"+t(e)).removeAttr("style"),sessionStorage.mi_id=$(this).attr("id"),l($(this)),"true"==localStorage["option-limited-highlight"]&&(o.limited_highlight=!0),g()})),$(window).scrollTop(localStorage.scroll_top);let a=sessionStorage.mi_id;null!=a&&l($("#"+t(a)))})),$((function(){let o,i;$(document).on("mouseup",(function(l){o=l.pageX,i=l.pageY,$(".sog-menu").css("display","none");let[c,d,s]=function(){var t,e,o,n;let i;if(window.getSelection?i=window.getSelection():document.getSelection&&(i=document.getSelection()),null==i||"Range"!=i.type)return[void 0,void 0,void 0];let l=null===(t=null==i?void 0:i.anchorNode)||void 0===t?void 0:t.parentElement,c=null===(e=null==i?void 0:i.focusNode)||void 0===e?void 0:e.parentElement;if(null==l||null==c)return[void 0,void 0,void 0];if(0==$(l).parents(".main").length||0==$(c).parents(".main").length)return[void 0,void 0,void 0];let a,d,s,r,u=l.getBoundingClientRect(),p=c.getBoundingClientRect();return u.top<p.top||u.top==p.top&&u.left<=p.left?[a,d]=[l,c]:[a,d]=[c,l],"gd_word"==a.className?s=a.id:"gd_word"==(null===(o=a.nextElementSibling)||void 0===o?void 0:o.className)?s=a.nextElementSibling.id:console.warn("Invalid span for a source of grounding"),"gd_word"==d.className?r=d.id:"gd_word"==(null===(n=d.previousElementSibling)||void 0===n?void 0:n.className)?r=d.previousElementSibling.id:console.warn("Invalid span for a source of grounding"),[s,r,a]}();if(null==s)return;$(".sog-menu input[type=submit]").button();let r=sessionStorage.mi_id;null!=r&&null!=a(e($("#"+t(r))))&&$(".sog-menu").css({left:o,top:i-20}).fadeIn(200).css("display","flex");let u=`<p>Selected mi: <span style="font-family: monospace;">${r}</span></p>`;$(".sog-add-menu-info").html(u),$(".sog-menu .sog-add").off("click"),$(".sog-menu .sog-add").on("click",(function(){$(".sog-menu").css("display","none");let t={mcdict_edit_id:n,mi_id:r,start_id:c,stop_id:d};localStorage.scroll_top=$(window).scrollTop(),$.when($.post("/_add_sog",t)).done((function(){location.reload()})).fail((function(){console.error("Failed to POST _add_sog!")}))})),null!=(null==s?void 0:s.getAttribute("data-sog-mi"))?$(".sog-mod-menu").css("display","inherit"):$(".sog-mod-menu").css("display","none");let p=s.getAttribute("data-sog-mi"),g=Number(s.getAttribute("data-sog-type")),f=s.getAttribute("data-sog-start"),m=s.getAttribute("data-sog-stop"),h="unknown";0==g?h="declaration":1==g?h="definition":2==g&&(h="others");let _=`<p>SoG for <span style="font-family: monospace;">${p}</span><br/>Type: ${h}</p>`;$(".sog-mod-menu-info").html(_),$(".sog-menu .sog-type").off("click"),$(".sog-menu .sog-type").on("click",(function(){if($(".sog-menu").css("display","none"),null==s)return;let t=$("#sog-type-dialog-template").clone();t.attr("id","sog-type-dialog"),t.removeClass("sog-type-dialog");let e=t.find("#sog-type-form");e.attr("action","/_change_sog_type"),t.find(`input[value="${g}"]`).prop("checked",!0),t.dialog({modal:!0,title:"Change SoG Type",width:200,buttons:{OK:function(){localStorage.scroll_top=$(window).scrollTop(),e.append(`<input type="hidden" name="mcdict_edit_id" value="${n}" />`),e.append(`<input type="hidden" name="mi_id" value="${p}" />`),e.append(`<input type="hidden" name="start_id" value="${f}" />`),e.append(`<input type="hidden" name="stop_id" value="${m}" />`),e.trigger("submit")},Cancel:function(){$(this).dialog("close")}},close:function(){$(this).remove()}})})),$(".sog-menu .sog-del").off("click"),$(".sog-menu .sog-del").on("click",(function(){if($(".sog-menu").css("display","none"),null==s)return;let t={mcdict_edit_id:n,mi_id:s.getAttribute("data-sog-mi"),start_id:s.getAttribute("data-sog-start"),stop_id:s.getAttribute("data-sog-stop")};localStorage.scroll_top=$(window).scrollTop(),$.when($.post("/_delete_sog",t)).done((function(){location.reload()})).fail((function(){console.error("Failed to POST _delete_sog!")}))}))}))})),$((function(){$("mi").each((function(){!function(t){let o=d(e(t));null==t.data("math-concept")&&null!=o&&t.attr("mathbackground","#D3D3D3")}($(this))}))}));for(let t=1;t<10;t++)$(document).on("keydown",(function(e){var o;$("#concept-dialog")[0]||e.key==t.toString(10)&&(o=t,$("#c"+(o-1))[0]&&($('input[name="concept"]').prop("checked",!1),$("#c"+(o-1)).prop("checked",!0)))}));function f(t){let o=[];t.is("mi")&&null!=d(e(t))&&(o=[t]);for(let e=0;e<t.children().length;e++){let n=t.children().eq(e);o=o.concat(f(n))}return o}$(document).on("keydown",(function(t){"Enter"==t.key&&($("#concept-dialog")[0]||$("#assign-concept").trigger("click"))})),$(document).on("keydown",(function(t){"j"==t.key?$("button#jump-to-next-unannotated-mi").trigger("click"):"k"==t.key&&$("button#jump-to-prev-unannotated-mi").trigger("click")})),$((function(){0!=$("#error-message").text().length&&$("#error-dialog").dialog({dialogClass:"error-dialog",modal:!0,title:"Error",buttons:{OK:function(){$(this).dialog("close")}}})}));let m=[],h={};$((function(){m=f($(":root"));for(let t=0;t<m.length;t++){let e=m[t].attr("id");null!=e?h[e]=t:(console.error("mi_id undefiend!"),console.error(t),console.error(m[t]))}})),$((function(){$("button#jump-to-next-unannotated-mi").button(),$("button#jump-to-next-unannotated-mi").on("click",(function(){var t;let o=m.length-1;null!=sessionStorage.mi_id&&sessionStorage.mi_id in h&&(o=h[sessionStorage.mi_id]);let n=function(t){for(let o=0;o<m.length;o++){let n=(t+o)%m.length;if(null==a(e(m[n])))return n}}((o+1)%m.length);if(null!=n){let e=m[n],o=null===(t=null==e?void 0:e.offset())||void 0===t?void 0:t.top,i=$(window).height();null!=o&&null!=i&&($(window).scrollTop(o-i/2),e.trigger("click"))}})),$("button#jump-to-prev-unannotated-mi").button(),$("button#jump-to-prev-unannotated-mi").on("click",(function(){var t;let o=0;null!=sessionStorage.mi_id&&sessionStorage.mi_id in h&&(o=h[sessionStorage.mi_id]);let n=function(t){for(let o=m.length;o>0;o--){let n=(t+o)%m.length;if(null==a(e(m[n])))return n}}((o+m.length-1)%m.length);if(null!=n){let e=m[n],o=null===(t=null==e?void 0:e.offset())||void 0===t?void 0:t.top,i=$(window).height();null!=o&&null!=i&&($(window).scrollTop(o-i/2),e.trigger("click"))}}))})),$((function(){$("button#back-to-selected-mi").button(),$("button#back-to-selected-mi").on("click",(function(){var e;if(null!=sessionStorage.mi_id){let o=$("#"+t(sessionStorage.mi_id)),n=null===(e=null==o?void 0:o.offset())||void 0===e?void 0:e.top,i=$(window).height();null!=n&&null!=i&&$(window).scrollTop(n-i/2)}}))})),$((function(){$(window).scrollTop(localStorage.scroll_top)}))})();